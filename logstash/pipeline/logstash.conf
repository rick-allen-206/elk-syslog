input {
	udp{
		port => 5140
		type => "syslog"
	}
	tcp{
		port => 5140
		type => "syslog"
	}
}

filter {
  if [type] == "syslog" {
    grok {
      match => [
				# IOS
				"message" => "%{SYSLOGTIMESTAMP:timestamp} %{SYSLOGHOST:logsource} (?<CISCOTIMESTAMPTZ> %{CISCOTIMESTAMP} %{TZ}) %{CISCO_REASON:facility}-%{INT:severity_level}-%{CISCO_REASON:facility_mnemonic}: %{GREEDYDATA:message}",
				# Misc. Syslogs
				#"message" => "%{SYSLOGTIMESTAMP:syslog_timestamp} %{SYSLOGHOST:syslog_hostname} %{DATA:syslog_program}(?:\[%{POSINT:syslog_pid}\])?: %{GREEDYDATA:syslog_message}"
			]
			add_tag => [ "cisco" ]
			add_field => [ "received_at", "%{@timestamp}" ]
      add_field => [ "received_from", "%{host}" ]
    }
    date {
      match => [ "syslog_timestamp", "MMM  d HH:mm:ss", "MMM dd HH:mm:ss" ]
    }
  }
	if "cisco" in [tags] {
		date {
			match => [
			"log_date",

			# IOS
			"MMM dd HH:mm:ss.SSS ZZZ",
			"MMM dd HH:mm:ss ZZZ",
			"MMM dd HH:mm:ss.SSS",

			# Nexus
			"YYYY MMM dd HH:mm:ss.SSS ZZZ",
			"YYYY MMM dd HH:mm:ss ZZZ",
			"YYYY MMM dd HH:mm:ss.SSS",

			# Hail marry
			"ISO8601"
			]
		}

		# Add the log level's name instead of just a number.
		mutate {
			gsub => [
			"severity_level", "0", "0 - Emergency",
			"severity_level", "1", "1 - Alert",
			"severity_level", "2", "2 - Critical",
			"severity_level", "3", "3 - Error",
			"severity_level", "4", "4 - Warning",
			"severity_level", "5", "5 - Notification",
			"severity_level", "6", "6 - Informational"
			]
		}
	}
}


output {
	elasticsearch {
		hosts => "elasticsearch:9200"
	}
	stdout {
		codec => rubydebug
	}
}
